<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>Test_Dead_Line.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#include "doctest.h"
#include "../Main/DeadlineTask.h"
#include "../Main/DeadlineTaskManager.h"
#include "../Main/Scheduler.h"
#include &lt;chrono&gt;
#include &lt;thread&gt;
#include &lt;memory&gt;
#include "Helper.h"
using namespace std;
<span style = "background-color:#dfd">TEST_CASE("Test DeadLineTask creation and management") {</span>
    // Initialize DeadlineTaskManager and Scheduler
<span style = "background-color:#dfd">    Scheduler scheduler(new ReadFromJSON(), new Utility());</span>
    //DeadlineTaskManager manager;
    
<span style = "background-color:#dfd">    SUBCASE("Test inserting tasks with different deadlines") {</span>
        //clearAll(scheduler);
        // Create deadline tasks with different deadlines
<span style = "background-color:#dfd">        auto deadLineTask1 = std::make_shared&lt;DeadLineTask&gt;(DeadLineTask(Task(1, PrioritiesLevel::LOWER, 1), time(nullptr) + 10));
        auto deadLineTask2 = std::make_shared&lt;DeadLineTask&gt;(DeadLineTask(Task(2, PrioritiesLevel::LOWER, 1), time(nullptr) + 1));</span>
        // Insert tasks into the scheduler
<span style = "background-color:#dfd">        scheduler.insertTask(deadLineTask1);
        scheduler.insertTask(deadLineTask2);</span>
        // Start the deadline mechanism in a separate thread
<span style = "background-color:#dfd">        std::thread deadlineThread([&amp;scheduler]() {
            scheduler.getDeadlineTaskManager().deadlineMechanism();
            });</span>
        // Detach the thread to finish execution
<span style = "background-color:#dfd">        deadlineThread.detach();</span>
        // Check the task at the top of the heap
<span style = "background-color:#dfd">        auto topTask = scheduler.getDeadlineTaskManager().getUpcomingTask();
        CHECK_EQ(topTask-&gt;getId(), 2);  // Task with ID 2 should be at the top</span>
        // Wait for the first task's deadline to pass
<span style = "background-color:#dfd">        std::this_thread::sleep_for(std::chrono::seconds(2));</span>
        // Check the task at the top again
<span style = "background-color:#dfd">        topTask = scheduler.getDeadlineTaskManager().getUpcomingTask();
        CHECK_EQ(topTask-&gt;getId(), 1);  // Task with ID 1 should now be at the top
    }</span>
    // Test the insertion of tasks into the heap
<span style = "background-color:#dfd">    SUBCASE("Test deadline task inserts to the heap") {</span>
        // Create tasks (task1: regular task, task2: deadline task)
<span style = "background-color:#dfd">        auto task1 = std::make_shared&lt;Task&gt;(1, PrioritiesLevel::HIGHER, 15);
        auto task2 = std::make_shared&lt;DeadLineTask&gt;(DeadLineTask(Task(2, PrioritiesLevel::LOWER, 10), time(nullptr) + 2));</span>
        // Insert tasks into the scheduler
<span style = "background-color:#dfd">        scheduler.insertTask(task1);
        scheduler.insertTask(task2);  // Assuming insertTask accepts both Task and DeadlineTask</span>
        // Verify if the correct task is at the top of the heap
<span style = "background-color:#dfd">        auto incomingTask = scheduler.getDeadlineTaskManager().getUpcomingTask();
        CHECK(incomingTask-&gt;getId() == task2-&gt;getId());
    }</span>
    // Test that a deadline task becomes critical after a certain time
<span style = "background-color:#dfd">    SUBCASE("Test deadline time becomes critical") {
        clearAll(scheduler);
        auto Task1 = std::make_shared&lt;Task&gt;(1, PrioritiesLevel::HIGHER, 15);
        auto baseTaskPtr = std::make_shared&lt;DeadLineTask&gt;(DeadLineTask(Task(2, PrioritiesLevel::LOWER, 10), time(nullptr) + 2));</span>
        // Insert tasks into the scheduler
<span style = "background-color:#dfd">        scheduler.insertTask(Task1);
        scheduler.insertTask(baseTaskPtr);</span>
        // Run the deadline mechanism in a separate thread
<span style = "background-color:#dfd">        std::thread deadlineThread([&amp;scheduler]() {
            cout &lt;&lt; scheduler.getRealTimeScheduler().getRealTimeQueue().size() &lt;&lt; "----------------" &lt;&lt; endl;
            scheduler.getDeadlineTaskManager().deadlineMechanism();
            });</span>
        // Allow time for tasks to be processed
<span style = "background-color:#dfd">        std::this_thread::sleep_for(std::chrono::seconds(3));</span>
        // Detach the thread to finish execution
<span style = "background-color:#dfd">        deadlineThread.detach();
        cout &lt;&lt; scheduler.getRealTimeScheduler().getRealTimeQueue().size() &lt;&lt; "----------------" &lt;&lt; endl;</span>
        // Verify that the task count in the real-time queue is 1
<span style = "background-color:#dfd">        CHECK(scheduler.getRealTimeScheduler().getRealTimeQueue().size() == 1);
    }</span>
    // Test the build of the heap by the pop
<span style = "background-color:#dfd">    SUBCASE("Pop from empty heap throws exception") {</span>
        DeadlineTaskManager manager;  // Create an instance of your class
        // Check if the correct exception is thrown when heap is empty
<span style = "background-color:#dfd">        CHECK_THROWS_WITH_AS(manager.getUpcomingTask(), "Heap is empty", std::runtime_error);
    }
    SUBCASE("Test DeadLineTask comparison operator") {</span>
        // Create two tasks with different deadlines
<span style = "background-color:#dfd">        DeadLineTask task1(Task(1, PrioritiesLevel::LOWER, 1), time(nullptr) + 10);  // Later deadline
        DeadLineTask task2(Task(2, PrioritiesLevel::LOWER, 1), time(nullptr) + 5);   // Earlier deadline</span>

        // Check that task1 is considered greater than task2 based on deadline
<span style = "background-color:#dfd">        CHECK(task2 &gt; task1);  // task1 has a later deadline, so it should be greater
        CHECK_FALSE(task1 &gt; task2);  // task2 has an earlier deadline, so it should not be greater
    }</span>

<span style = "background-color:#dfd">}</span>
//</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>